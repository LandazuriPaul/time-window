name: Next Semantic Version

on:
  workflow_call:
    outputs:
      next_release_version:
        description: The next semantic release version
        value: ${{ jobs.next_version.outputs.next_semantic_version }}

jobs:
  next_version:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      next_semantic_version: ${{ steps.semantic.outputs.NEXT_SEMANTIC_RELEASE_VERSION }}
    steps:
      - name: Checkout PR
        if: github.event_name == 'pull_request'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.head_ref }}

      - name: Checkout Push
        if: github.event_name == 'push'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get branch name
        id: branch
        shell: bash
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "BRANCH=${{ github.head_ref }}" >> $GITHUB_OUTPUT
          else
            echo "BRANCH=${GITHUB_REF##*/}" >> $GITHUB_OUTPUT
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "lts/*"

      - name: Get next semantic version
        id: semantic
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          unset GITHUB_ACTIONS && npx semantic-release --dry-run --no-ci --branches "${{ steps.branch.outputs.BRANCH }}"
          echo "NEXT_SEMANTIC_RELEASE_VERSION=$(unset GITHUB_ACTIONS && npx semantic-release --dry-run --no-ci --branches "${{ steps.branch.outputs.BRANCH }}" | grep 'next release version is' | sed -E 's/.* ([[:digit:].]+)$/\1/')" >> $GITHUB_OUTPUT
